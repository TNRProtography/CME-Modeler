<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spot The Aurora - West Coast Aurora Forecast</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-main: #0a0a0a;
            --bg-card: #171717;
            --bg-gauge-track: #27272a;
            --border-color: #3f3f46;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --link-color: #60a5fa;
            --aurora-green: rgba(46, 204, 113, 0.25);
            --aurora-blue: rgba(52, 152, 219, 0.2);
            --aurora-purple: rgba(155, 89, 182, 0.22);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: var(--bg-main);
            color: var(--text-secondary);
            margin: 0;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        body.modal-open {
            overflow: hidden;
        }
        body::before,
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 200%;
            height: 40vh;
            z-index: 0;
            opacity: 0.9;
            will-change: transform;
            mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
        }
        body::before {
            background: 
                radial-gradient(circle at 25% 80%, var(--aurora-green) 0%, transparent 50%),
                radial-gradient(circle at 75% 70%, var(--aurora-blue) 0%, transparent 60%);
            animation: moveAurora 30s linear infinite;
        }
        body::after {
            background: 
                radial-gradient(circle at 20% 100%, var(--aurora-purple) 0%, transparent 50%),
                radial-gradient(circle at 80% 90%, var(--aurora-green) 0%, transparent 60%);
            animation: moveAurora 45s linear infinite reverse;
        }
        @keyframes moveAurora {
            from { transform: translateX(-50%); }
            to { transform: translateX(0%); }
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            position: relative;
            z-index: 1;
        }
        .header { 
            display: flex; 
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px; 
            text-align: center;
        }
        .header-logo {
            max-width: 250px;
            height: auto;
            margin-bottom: 15px;
        }
        .header .logo-link {
            display: inline-block;
            transition: transform 0.2s ease-in-out;
        }
        .header .logo-link:hover {
            transform: scale(1.03);
        }
        h1 { 
            font-size: 2.25rem; 
            color: var(--text-primary); 
            margin: 0; 
        }
        .dashboard-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; }
        .card { 
            background-color: rgba(23, 23, 23, 0.85);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--border-color); 
            border-radius: 16px; 
            padding: 25px; 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); 
            text-align: center; 
            display: flex; 
            flex-direction: column;
        }
        .card-title { font-size: 1.1rem; text-align: center; font-weight: 600; color: var(--text-primary); margin: 0; }
        
        .card-title-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        .tooltip-trigger {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 18px;
            height: 18px;
            border: 1.5px solid var(--text-muted);
            border-radius: 50%;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tooltip-trigger:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
            border-color: var(--link-color);
        }
       
        #nz-spotlight { grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: center; text-align: left; }
        #nz-spotlight .card-title { text-align: left; }
        #nz-spotlight .card-title-container { justify-content: flex-start; }
        #aurora-score-display { padding-right: 30px; border-right: 1px solid var(--border-color); }
        #aurora-score-label { font-size: 1.1rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; }
        #aurora-score { font-size: 4rem; font-weight: 800; color: var(--text-primary); line-height: 1; }
        .emoji { font-size: 3rem; vertical-align: middle; margin-left: 10px; }
        #last-updated { font-size: 0.9rem; color: var(--text-muted); margin-top: 15px; }
        #thermometer-container { height: 12px; width: 100%; background-color: var(--bg-gauge-track); border-radius: 6px; margin-top: 20px; overflow: hidden; }
        #thermometer-line { height: 100%; border-radius: 6px; width: 0%; transition: width 1.5s ease, background-color 1s ease; }
        #aurora-blurbs { font-size: 1rem; color: var(--text-secondary); }
        .aurora-blurb { display: none; }
        .gauge-grid { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .gauge-value { font-size: 2.25rem; font-weight: 700; color: var(--text-primary); margin: 10px 0; }
        .gauge-emoji { font-size: 2rem; margin: 5px 0 15px 0; min-height: 1.2em; }
        .gauge-bar-track { height: 8px; width: 100%; background-color: var(--bg-gauge-track); border-radius: 4px; overflow: hidden; }
        .gauge-bar { height: 100%; width: 0%; border-radius: 4px; transition: width 1.5s ease, background-color 1s ease; }
        .gauge-last-updated { font-size: 0.8rem; color: var(--text-muted); margin-top: auto; padding-top: 15px; }
        .chart-card {
            grid-column: span 6;
            height: 450px;
            display: flex;
            flex-direction: column;
        }
        .chart-card .card-title-container { justify-content: flex-start; }
        .chart-wrapper {
            position: relative;
            flex-grow: 1;
            min-height: 0;
        }
        .chart-wrapper canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .page-footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .page-footer h3 {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-weight: 600;
        }
        .page-footer p {
            max-width: 800px;
            margin: 0 auto 1.5em auto;
            line-height: 1.7;
        }
        .page-footer a {
            color: var(--link-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }
        .page-footer a:hover {
            text-decoration: underline;
            color: #93c5fd;
        }
        .community-links-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
        }
        .community-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 25px;
            margin-bottom: 30px;
        }
        .community-link {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 12px 24px;
            border-radius: 12px;
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .community-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.3);
            border-color: var(--link-color);
        }
        .community-link svg {
            width: 24px;
            height: 24px;
            fill: var(--link-color);
        }
        .footer-credits {
            margin-top: 30px;
            font-size: 0.85rem;
        }
        .footer-credits span {
            margin: 0 8px;
        }
        
        /* --- NEW MODAL STYLES --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .modal-title {
            font-size: 1.25rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        .modal-close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 2.5rem;
            line-height: 1;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .modal-close-btn:hover {
            color: var(--text-primary);
            transform: rotate(90deg);
        }
        .modal-body {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-secondary);
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 10px; /* For scrollbar */
        }
        .modal-body strong {
            color: var(--text-primary);
        }
        .modal-body ul {
            padding-left: 20px;
            margin: 10px 0 0 0;
        }
        .modal-body li {
            margin-bottom: 8px;
        }
        .modal-body .color-swatch {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 8px;
            vertical-align: middle;
        }
        /* --- End of Modal Styles --- */

        @media (max-width: 1200px) { .chart-card { grid-column: 1 / -1; } }
        @media (max-width: 900px) { h1 { font-size: 1.75rem; } #nz-spotlight { grid-template-columns: 1fr; } #aurora-score-display { border-right: none; border-bottom: 1px solid var(--border-color); padding-right: 0; padding-bottom: 20px; margin-bottom: 20px; } }
        @media (max-width: 600px) { body { padding: 10px; } .card { padding: 20px; } }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <a href="https://www.tnrprotography.co.nz" target="_blank" rel="noopener noreferrer" class="logo-link">
            <img src="https://www.tnrprotography.co.nz/uploads/1/3/6/6/136682089/white-tnr-protography-w_orig.png" alt="TNR Protography Logo" class="header-logo">
        </a>
        <h1>Spot The Aurora - West Coast Aurora Forecast</h1>
    </header>

    <main class="dashboard-grid">
        <div id="nz-spotlight" class="card">
            <div id="aurora-score-display">
                <div class="card-title-container">
                    <h2 class="card-title">Spot The Aurora Forecast</h2>
                    <div class="tooltip-trigger" data-modal-id="forecast">?</div>
                </div>
                <div id="aurora-score">Loading...</div>
                <div id="thermometer-container"><div id="thermometer-line"></div></div>
                <div id="last-updated">Last Updated: Loading...</div>
            </div>
            <div id="aurora-blurbs"><div class="aurora-blurb" id="blurb-10">Little to no auroral activity.</div><div class="aurora-blurb" id="blurb-25">Minimal auroral activity likely.</div><div class="aurora-blurb" id="blurb-40">Clear auroral activity visible in cameras.</div><div class="aurora-blurb" id="blurb-50">Faint auroral glow potentially visible to the naked eye.</div><div class="aurora-blurb" id="blurb-80">Good chance of seeing naked-eye auroral color.</div><div class="aurora-blurb" id="blurb-80plus">High probability of significant auroral substorms.</div></div>
        </div>
        
        <div class="gauge-grid">
            <div class="card gauge">
                <div class="card-title-container">
                    <h3 class="card-title">Hemispheric Power</h3>
                    <div class="tooltip-trigger" data-modal-id="power">?</div>
                </div>
                <div class="gauge-value" id="power-value">...</div><div class="gauge-emoji" id="power-emoji">...</div><div class="gauge-bar-track"><div class="gauge-bar" id="power-gauge-bar"></div></div><div class="gauge-last-updated" id="power-last-updated">...</div>
            </div>
            <div class="card gauge">
                <div class="card-title-container">
                    <h3 class="card-title">Solar Wind Speed</h3>
                    <div class="tooltip-trigger" data-modal-id="speed">?</div>
                </div>
                <div class="gauge-value" id="speed-value">...</div><div class="gauge-emoji" id="speed-emoji">...</div><div class="gauge-bar-track"><div class="gauge-bar" id="speed-gauge-bar"></div></div><div class="gauge-last-updated" id="speed-last-updated">...</div>
            </div>
            <div class="card gauge">
                <div class="card-title-container">
                    <h3 class="card-title">Solar Wind Density</h3>
                    <div class="tooltip-trigger" data-modal-id="density">?</div>
                </div>
                <div class="gauge-value" id="density-value">...</div><div class="gauge-emoji" id="density-emoji">...</div><div class="gauge-bar-track"><div class="gauge-bar" id="density-gauge-bar"></div></div><div class="gauge-last-updated" id="density-last-updated">...</div>
            </div>
            <div class="card gauge">
                <div class="card-title-container">
                    <h3 class="card-title">IMF Bt (Total)</h3>
                    <div class="tooltip-trigger" data-modal-id="bt">?</div>
                </div>
                <div class="gauge-value" id="bt-value">...</div><div class="gauge-emoji" id="bt-emoji">...</div><div class="gauge-bar-track"><div class="gauge-bar" id="bt-gauge-bar"></div></div><div class="gauge-last-updated" id="bt-last-updated">...</div>
            </div>
            <div class="card gauge">
                <div class="card-title-container">
                    <h3 class="card-title">IMF Bz (N/S)</h3>
                    <div class="tooltip-trigger" data-modal-id="bz">?</div>
                </div>
                <div class="gauge-value" id="bz-value">...</div><div class="gauge-emoji" id="bz-emoji">...</div><div class="gauge-bar-track"><div class="gauge-bar" id="bz-gauge-bar"></div></div><div class="gauge-last-updated" id="bz-last-updated">...</div>
            </div>
        </div>

        <div class="card chart-card">
            <div class="card-title-container">
                <h2 class="card-title">Aurora Visibility (Past 6 Hours)</h2>
                <div class="tooltip-trigger" data-modal-id="chart">?</div>
            </div>
            <div class="chart-wrapper">
                <canvas id="auroraChart"></canvas>
            </div>
        </div>
        <div class="card chart-card">
            <div class="card-title-container">
                <h2 class="card-title">Magnetic Field Components (Past 2 Hours)</h2>
            </div>
            <div class="chart-wrapper">
                <canvas id="magneticFieldChart"></canvas>
            </div>
        </div>
    </main>

    <footer class="page-footer">
        <h3>About This Forecast</h3>
        <p>This forecast is derived from a proprietary algorithm that considers several key factors influencing auroral visibility on the West Coast of New Zealand. The model incorporates lunar illumination, astronomical darkness, Hemispheric Power, and the critical Bt/Bz components of the interplanetary magnetic field. This provides a more localized and nuanced prediction compared to broader-coverage models like the NOAA Ovation.</p>
        <p><strong>Disclaimer:</strong> The aurora is a natural phenomenon. This forecast is an indication of potential activity, not a guarantee of a visible display. The model is not a live substorm magnetometer; it provides an estimate of probable conditions over a two-hour window, with updates continually refining the outlook.</p>
        <div class="community-links-section">
            <h3>Get Real-Time Alerts & Join the Discussion</h3>
            <p>The forecast is great, but the aurora can be unpredictable. Get instant notifications sent directly to your device when conditions look promising, and share your sightings with our growing community of West Coast aurora chasers!</p>
            <div class="community-links">
                <a href="https://www.facebook.com/profile.php?id=61575593713727" class="community-link" target="_blank" rel="noopener noreferrer">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.12,5.32H17V2.14A26.11,26.11,0,0,0,14.26,2C11.54,2,9.68,3.66,9.68,6.7V9.32H6.61v3.56H9.68V22h3.68V12.88h3.06l.46-3.56H13.36V7.05C13.36,6,13.64,5.32,15.12,5.32Z"/></svg>
                    <span>Facebook Alerts Page</span>
                </a>
                <a href="https://t.me/Spot_The_Aurora" class="community-link" target="_blank" rel="noopener noreferrer">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.8,3.24a2,2,0,0,0-1.87-1.15c-3,.2-16.36,6.08-16.36,6.08a1,1,0,0,0,.1,1.8l3.65,1.14,1.1,3.83a1,1,0,0,0,1.82.16s2.5-3.37,3.61-4.57,1.83-1.28,1.83-1.28a1,1,0,0,0-.12-1.82S4.85,5.4,4.48,5.13a1,1,0,0,0-1.42,1l8.53,7.83a1,1,0,0,0,1.45.19l7.53-5.26A2,2,0,0,0,21.8,3.24Z"/></svg>
                    <span>Telegram Alerts Channel</span>
                </a>
                <a href="https://www.facebook.com/groups/spottheaurora.greywestland" class="community-link" target="_blank" rel="noopener noreferrer">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm0,18a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z"/><path d="M12,7a3,3,0,1,0,3,3A3,3,0,0,0,12,7Zm0,4a1,1,0,1,1,1-1A1,1,0,0,1,12,11Z"/><path d="M18.63,16.27l-.28-.27a1,1,0,0,0-1.28-.1,5,5,0,0,0-1.29.62,1,1,0,0,0-.24.16,1,1,0,0,0-.1.14,3.29,3.29,0,0,1-1.3,1.1,3.48,3.48,0,0,1-3.66,0,3.29,3.29,0,0,1-1.3-1.1A1.18,1.18,0,0,0,9,16.62a1,1,0,0,0-1.28.1l-.28.27a8.44,8.44,0,0,0-1.41,1.55,1,1,0,0,0,.15,1.4,8,8,0,0,0,11.38,0,1,1,0,0,0,.15-1.4A8.44,8.44,0,0,0,18.63,16.27Z"/></svg>
                    <span>Facebook Discussion Group</span>
                </a>
            </div>
        </div>
        <div class="footer-credits">
            <span>Data courtesy of <a href="https://www.swpc.noaa.gov/" target="_blank" rel="noopener noreferrer">NOAA SWPC</a></span>
            <span>•</span>
            <span>Forecast & Visualization by <a href="https://www.tnrprotography.co.nz/" target="_blank" rel="noopener noreferrer">TNR Protography</a></span>
        </div>
    </footer>
</div>

<!-- NEW: Reusable Modal Structure -->
<div id="info-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title" class="modal-title"></h3>
            <button id="modal-close-btn" class="modal-close-btn">×</button>
        </div>
        <div id="modal-body" class="modal-body">
            <!-- Content is injected here by JavaScript -->
        </div>
    </div>
</div>

<script>
    let auroraChartInstance = null;
    let magneticChart = null;
    let apiDataCache = {}; 
    const NOAA_PLASMA_ENDPOINT = 'https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json';
    const NOAA_MAG_ENDPOINT = 'https://services.swpc.noaa.gov/products/solar-wind/mag-2-hour.json';
    
    const GAUGE_API_ENDPOINTS = {
        power: 'https://hemispheric-power.thenamesrock.workers.dev/',
        speed: NOAA_PLASMA_ENDPOINT,
        density: NOAA_PLASMA_ENDPOINT,
        bt: NOAA_MAG_ENDPOINT,
        bz: NOAA_MAG_ENDPOINT
    };
    const GAUGE_THRESHOLDS = { speed: { gray: 250, yellow: 350, orange: 500, red: 650, purple: 800, pink: Infinity, maxExpected: 1000 }, density: { gray: 5, yellow: 10, orange: 15, red: 20, purple: 50, pink: Infinity, maxExpected: 70 }, power: { gray: 20, yellow: 40, orange: 70, red: 150, purple: 200, pink: Infinity, maxExpected: 250 }, bt: { gray: 5, yellow: 10, orange: 15, red: 20, purple: 50, pink: Infinity, maxExpected: 60 }, bz: { gray: -5, yellow: -10, orange: -15, red: -20, purple: -50, pink: -50, maxNegativeExpected: -60 }};
    const GAUGE_COLORS = { gray: '#808080', yellow: '#FFD700', orange: '#FFA500', red: '#FF4500', purple: '#800080', pink: '#FF1493' };
    const GAUGE_EMOJIS = { gray: '\u{1F610}', yellow: '\u{1F642}', orange: '\u{1F642}', red: '\u{1F604}', purple: '\u{1F60D}', pink: '\u{1F60D}', error: '\u{2753}' };
    const UPDATE_INTERVAL_MS = 120000;
    
    function formatTimestamp(isoString) { try { const d = new Date(isoString); return isNaN(d.getTime()) ? "Invalid Date" : `${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`; } catch { return "Invalid Date"; } }
    function getGaugeStyle(v, t) { if (v == null || isNaN(v)) return { color: GAUGE_COLORS.gray, emoji: GAUGE_EMOJIS.error, percentage: 0 }; let k='pink', p=0; if (t==='bz') { k=v<=-50?'pink':v<=-20?'purple':v<=-15?'red':v<=-10?'orange':v<=-5?'yellow':'gray'; p=v<0?Math.min(100,Math.max(0,(v/GAUGE_THRESHOLDS.bz.maxNegativeExpected)*100)):0; } else { const th=GAUGE_THRESHOLDS[t]; k=v<=th.gray?'gray':v<=th.yellow?'yellow':v<=th.orange?'orange':v<=th.red?'red':v<=th.purple?'purple':'pink'; p=Math.min(100,Math.max(0,(v/th.maxExpected)*100)); } return { color: GAUGE_COLORS[k], emoji: GAUGE_EMOJIS[k], percentage: p }; }
    async function updateGauge(type) {
        const endpoint = GAUGE_API_ENDPOINTS[type];
        const { value: valEl, emoji: emEl, lastUpdated: luEl, bar: barEl } = { value: document.getElementById(`${type}-value`), emoji: document.getElementById(`${type}-emoji`), lastUpdated: document.getElementById(`${type}-last-updated`), bar: document.getElementById(`${type}-gauge-bar`) };
        try {
            if (type === 'power') {
                const response = await fetch(endpoint); if (!response.ok) throw new Error(`Fetch failed for power`);
                const data = await response.json(); const latestData = data.values[data.values.length - 1]; const value = parseFloat(latestData.value); const style = getGaugeStyle(value, type); valEl.innerText = `${value.toFixed(1)} GW`; emEl.innerHTML = style.emoji; luEl.innerText = `Last Updated: ${formatTimestamp(latestData.lastUpdated)}`; barEl.style.width = `${style.percentage}%`; barEl.style.backgroundColor = style.color; return;
            }
            let data = apiDataCache[endpoint];
            if (!data) { const response = await fetch(endpoint); if (!response.ok) throw new Error(`Network error: ${response.status}`); data = await response.json(); apiDataCache[endpoint] = data; }
            if (!Array.isArray(data) || data.length < 2) throw new Error("Invalid NOAA data format");
            const headers = data[0]; const columnName = type === 'bz' ? 'bz_gsm' : type; const valueIndex = headers.indexOf(columnName); const timeIndex = headers.indexOf('time_tag');
            if (valueIndex === -1 || timeIndex === -1) throw new Error(`Column not found: ${columnName}`);
            let latestRow = null;
            for (let i = data.length - 1; i > 0; i--) { const row = data[i]; const val = parseFloat(row[valueIndex]); if (!isNaN(val) && val > -9999) { latestRow = row; break; } }
            if (!latestRow) throw new Error("No valid recent data found");
            const value = parseFloat(latestRow[valueIndex]); const lastUpdated = latestRow[timeIndex];
            const unit = type==='speed'?' km/s':type==='density'?' p/cm³': ' nT'; const style = getGaugeStyle(value, type); valEl.innerText = `${value.toFixed(1)}${unit}`; emEl.innerHTML = style.emoji; luEl.innerText = `Last Updated: ${formatTimestamp(lastUpdated)}`; barEl.style.width = `${style.percentage}%`; barEl.style.backgroundColor = style.color;
        } catch (error) { console.error(`[${type}] Error updating gauge:`, error); valEl.innerText = "Error"; emEl.innerHTML = GAUGE_EMOJIS.error; luEl.innerText = `Update Failed: ${error.message.substring(0,30)}`; barEl.style.width='0%'; }
    }
    
    async function renderMagneticChart() {
        const ctx = document.getElementById('magneticFieldChart').getContext('2d');
        try {
            let data = apiDataCache[NOAA_MAG_ENDPOINT]; if (!data) { const response = await fetch(NOAA_MAG_ENDPOINT); if (!response.ok) throw new Error(`Fetch failed`); data = await response.json(); apiDataCache[NOAA_MAG_ENDPOINT] = data; }
            if (!Array.isArray(data) || data.length < 2) throw new Error("Invalid NOAA data format");
            const headers = data[0]; const timeIndex = headers.indexOf('time_tag'); const btIndex = headers.indexOf('bt'); const bzIndex = headers.indexOf('bz_gsm');
            const chartPoints = data.slice(1).map(row => ({ 
                time: new Date(row[timeIndex]), 
                bt: parseFloat(row[btIndex]) > -9999 ? parseFloat(row[btIndex]) : null, 
                bz: parseFloat(row[bzIndex]) > -9999 ? parseFloat(row[bzIndex]) : null, 
            }));
            if (chartPoints.length === 0) return;
            const labels = chartPoints.map(p => p.time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            const btValues = chartPoints.map(p => p.bt);
            const bzValues = chartPoints.map(p => p.bz);
            const allValues = [...btValues, ...bzValues].filter(v => v !== null); 
            const dataMin = allValues.length > 0 ? Math.min(...allValues) : -5;
            const dataMax = allValues.length > 0 ? Math.max(...allValues) : 5;
            const padding = Math.max((dataMax - dataMin) * 0.1, 1); const yMin = Math.floor(dataMin - padding); const yMax = Math.ceil(dataMax + padding);
            const chartData = { labels, datasets: [ { label: 'Bt (Total)', data: btValues, borderColor: '#A9A9A9', backgroundColor: 'rgba(169, 169, 169, 0.2)', borderWidth: 1.5, tension: 0.3, pointRadius: 0, spanGaps: true }, { label: 'Bz (N/S)', data: bzValues, borderColor: '#FF6347', backgroundColor: 'rgba(255, 99, 71, 0.3)', borderWidth: 1.5, tension: 0.3, pointRadius: 0, spanGaps: true } ] };
            if (magneticChart) { magneticChart.data = chartData; magneticChart.options.scales.y.min = yMin; magneticChart.options.scales.y.max = yMax; magneticChart.update(); } 
            else { 
                magneticChart = new Chart(ctx, { 
                    type: 'line', 
                    data: chartData, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        layout: { padding: { left: 10, right: 20, top: 10, bottom: 20 } },
                        plugins: { legend: { labels: { color: '#a1a1aa' } }, title: { display: false } }, 
                        scales: { 
                            x: { ticks: { color: '#71717a', maxRotation: 0, autoSkip: true, maxTicksLimit: 8 }, grid: { color: '#3f3f46' } }, 
                            y: { min: yMin, max: yMax, ticks: { color: '#71717a' }, grid: { color: c=>c.tick.value===0?'#fafafa':'#3f3f46', lineWidth:c=>c.tick.value===0?1.5:1 } } 
                        }, 
                        interaction: { mode: 'index', intersect: false } 
                    } 
                }); 
            }
        } catch (e) { console.error("Error rendering magnetic chart:", e); }
    }
    
    function getAuroraEmoji(s){return s<10?'\u{1F61F}':s<25?'\u{1F610}':s<50?'\u{1F642}':s<80?'\u{1F600}':'\u{1F929}'}
    function updateThermometer(s){const t=document.getElementById('thermometer-line');t.style.width=Math.min(s,100)+'%';t.style.backgroundColor=s<10?'#808080':s<25?'#FFD700':s<40?'#FFA500':s<50?'#FF4500':s<80?'#800080':'#FF1493'}
    function updateAuroraBlurb(s){document.querySelectorAll('#aurora-blurbs .aurora-blurb').forEach(e=>e.style.display='none');document.getElementById(s<10?'blurb-10':s<25?'blurb-25':s<40?'blurb-40':s<50?'blurb-50':s<80?'blurb-80':'blurb-80plus').style.display='block'}
    
    async function fetchSensor() {
        try {
            const [tnrResponse, basicResponse] = await Promise.all([fetch('https://tnr-aurora-forecast.thenamesrock.workers.dev/'), fetch('https://basic-aurora-forecast.thenamesrock.workers.dev/')]);
            if (!tnrResponse.ok || !basicResponse.ok) throw new Error(`Fetch failed`);
            const tnrData = await tnrResponse.json(); const basicData = await basicResponse.json(); const scoreValue = parseFloat(tnrData.values.pop().value); document.getElementById('aurora-score').innerHTML = `${scoreValue.toFixed(1)}% <span class="emoji">${getAuroraEmoji(scoreValue)}</span>`;
            const lastUpdated = new Date(basicData.values.pop().lastUpdated); document.getElementById('last-updated').innerText = `Last Updated: ${lastUpdated.toLocaleDateString()} ${lastUpdated.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            updateThermometer(scoreValue); updateAuroraBlurb(scoreValue);
        } catch (error) { console.error("Error fetching NZ sensor data:", error); document.getElementById('aurora-score').innerHTML = `Error <span class="emoji">❓</span>`; document.getElementById('last-updated').innerText = `Update Failed: ${error.message}`; updateThermometer(0); updateAuroraBlurb(-1); }
    }
    
    async function renderAuroraChart() {
        const ctx = document.getElementById('auroraChart').getContext('2d');
        try {
            const [response1, response2] = await Promise.all([
                fetch('https://basic-aurora-forecast.thenamesrock.workers.dev/'),
                fetch('https://tnr-aurora-forecast.thenamesrock.workers.dev/')
            ]);
            if (!response1.ok || !response2.ok) {
                throw new Error(`Failed to fetch aurora data: ${response1.status}, ${response2.status}`);
            }
            const json1 = await response1.json();
            const json2 = await response2.json();
            const processApiData = (dataArray) => {
                if (!Array.isArray(dataArray)) return [];
                const uniqueMap = new Map(dataArray.map(item => [item.lastUpdated, item]));
                return Array.from(uniqueMap.values())
                    .map(item => ({
                        time: new Date(item.lastUpdated),
                        value: parseFloat(item.value)
                    }))
                    .sort((a, b) => a.time - b.time);
            };
            const data1 = processApiData(json1.values);
            const data2 = processApiData(json2.values);
            const labels = [], points1 = [], points2 = [];
            const now = new Date();
            const sixHoursAgo = now.getTime() - (6 * 60 * 60 * 1000);
            const tenMinutes = 10 * 60 * 1000;
            const startTime = new Date(Math.floor(sixHoursAgo / tenMinutes) * tenMinutes);
            let dataIndex1 = 0, dataIndex2 = 0;
            let lastKnownValue1 = null, lastKnownValue2 = null;
            for (let t = new Date(startTime); t <= now; t.setTime(t.getTime() + tenMinutes)) {
                labels.push(t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                while (dataIndex1 < data1.length && data1[dataIndex1].time <= t) {
                    lastKnownValue1 = data1[dataIndex1].value;
                    dataIndex1++;
                }
                points1.push(lastKnownValue1);
                while (dataIndex2 < data2.length && data2[dataIndex2].time <= t) {
                    lastKnownValue2 = data2[dataIndex2].value;
                    dataIndex2++;
                }
                points2.push(lastKnownValue2);
            }
            const chartData = {
                labels: labels,
                datasets: [
                    { label: 'Base Score', data: points1, borderColor: '#A9A9A9', backgroundColor: 'rgba(169, 169, 169, 0.2)', tension: 0.4, borderWidth: 1.5, pointRadius: 0, spanGaps: true },
                    { label: 'Real Score', data: points2, borderColor: '#FF6347', backgroundColor: 'rgba(255, 99, 71, 0.3)', tension: 0.4, borderWidth: 1.5, pointRadius: 0, spanGaps: true }
                ]
            };
            if (auroraChartInstance) {
                auroraChartInstance.data = chartData;
                auroraChartInstance.update();
            } else {
                auroraChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true, 
                        maintainAspectRatio: false,
                        layout: { padding: { left: 10, right: 20, top: 10, bottom: 20 } },
                        plugins: { legend: { labels: { color: '#a1a1aa' } }, title: { display: false } },
                        scales: {
                            x: { ticks: { color: '#71717a', autoSkip: true, maxTicksLimit: 12 }, grid: { color: '#3f3f46' } },
                            y: { min: 0, max: 100, ticks: { color: '#71717a' }, grid: { color: '#3f3f46' } }
                        },
                        interaction: { mode: 'index', intersect: false }
                    }
                });
            }
        } catch (e) {
            console.error("Error rendering aurora chart:", e);
        }
    }
    
    function runAllUpdates() {
        console.log(`Updating all data at ${new Date().toLocaleTimeString()}...`);
        apiDataCache = {};
        fetchSensor();
        renderAuroraChart();
        Object.keys(GAUGE_API_ENDPOINTS).forEach(type => updateGauge(type));
        renderMagneticChart();
    }

    // --- MODIFIED & NEW JAVASCRIPT for Modals ---
    function initializeInfoModals() {
        const modalContent = {
            'forecast': {
                title: 'About The Forecast Score',
                content: `This is a proprietary TNR Protography forecast that combines live solar wind data with local conditions like lunar phase and astronomical darkness. It is highly accurate for the next 2 hours. Remember, patience is key and always look south!
                          <br><br><strong>What the Percentage Means:</strong>
                          <ul>
                            <li><strong>< 10% 😞:</strong> Little to no auroral activity.</li>
                            <li><strong>10-25% 😐:</strong> Minimal activity; cameras may detect a faint glow.</li>
                            <li><strong>25-40% 😊:</strong> Clear activity on camera; a faint naked-eye glow is possible.</li>
                            <li><strong>40-50% 🙂:</strong> Faint naked-eye aurora likely, maybe with color.</li>
                            <li><strong>50-80% 😀:</strong> Good chance of naked-eye color and structure.</li>
                            <li><strong>80%+ 🤩:</strong> High probability of a significant substorm.</li>
                          </ul>`
            },
            'chart': {
                title: 'Reading The Visibility Chart',
                content: `This chart shows the estimated visibility over time.<br><br>
                          <strong><span class="color-swatch" style="background-color: #FF6347;"></span>Real Score:</strong> This is the main forecast, including solar wind data and local factors like moonlight and darkness.<br><br>
                          <strong><span class="color-swatch" style="background-color: #A9A9A9;"></span>Base Score:</strong> This shows the forecast based *only* on solar wind data. It represents the "raw potential" if there were no sun or moon interference.`
            },
            'power': {
                title: 'Hemispheric Power',
                content: `<strong>What it is:</strong> The total energy being deposited by the solar wind into an entire hemisphere (North or South), measured in Gigawatts (GW).<br><br>
                         <strong>Effect on Aurora:</strong> Think of this as the aurora's overall brightness level. Higher power means more energy is available for a brighter and more widespread display.`
            },
            'speed': {
                title: 'Solar Wind Speed',
                content: `<strong>What it is:</strong> The speed of the charged particles flowing from the Sun, measured in kilometers per second (km/s).<br><br>
                         <strong>Effect on Aurora:</strong> Faster particles hit Earth's magnetic field with more energy, leading to more dynamic and vibrant auroras with faster-moving structures.`
            },
            'density': {
                title: 'Solar Wind Density',
                content: `<strong>What it is:</strong> The number of particles within a cubic centimeter of the solar wind, measured in protons per cm³.<br><br>
                          <strong>Effect on Aurora:</strong> Higher density means more particles are available to collide with our atmosphere, resulting in more widespread and "thicker" looking auroral displays.`
            },
            'bt': {
                title: 'IMF Bt (Total)',
                content: `<strong>What it is:</strong> The total strength of the Interplanetary Magnetic Field (IMF), measured in nanoteslas (nT).<br><br>
                          <strong>Effect on Aurora:</strong> A high Bt value indicates a strong magnetic field. While not a guarantee on its own, a strong field can carry more energy and lead to powerful events if the Bz is also favorable.`
            },
            'bz': {
                title: 'IMF Bz (N/S)',
                content: `<strong>What it is:</strong> The North-South direction of the IMF, measured in nanoteslas (nT). This is the most critical component.<br><br>
                          <strong>Effect on Aurora:</strong> Think of Bz as the "gatekeeper." When Bz is strongly <strong>negative (south)</strong>, it opens a gateway for solar wind energy to pour in. A positive Bz closes this gate. <strong>The more negative, the better!</strong>`
            }
        };

        const modalOverlay = document.getElementById('info-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeBtn = document.getElementById('modal-close-btn');
        const triggers = document.querySelectorAll('.tooltip-trigger');

        if (!modalOverlay || !closeBtn) return;

        function openModal(id) {
            const content = modalContent[id];
            if (!content) return;
            
            modalTitle.textContent = content.title;
            modalBody.innerHTML = content.content;

            document.body.classList.add('modal-open');
            modalOverlay.classList.add('visible');
        }

        function closeModal() {
            document.body.classList.remove('modal-open');
            modalOverlay.classList.remove('visible');
        }

        triggers.forEach(trigger => {
            trigger.addEventListener('click', () => {
                const modalId = trigger.dataset.modalId;
                openModal(modalId);
            });
        });

        closeBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (event) => {
            if (event.target === modalOverlay) {
                closeModal();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        runAllUpdates();
        setInterval(runAllUpdates, UPDATE_INTERVAL_MS);
        initializeInfoModals(); // Initialize the new modal functionality
    });
</script>

</body>
</html>