<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spot The Aurora - West Coast Aurora Forecast by TNR Protography</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- GLOBAL & THEME STYLES --- */
        :root {
            --bg-main: #0a0a0a;
            --bg-card: #171717;
            --bg-gauge-track: #27272a;
            --border-color: #3f3f46;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --link-color: #60a5fa;
            /* Aurora Colors */
            --aurora-green: rgba(46, 204, 113, 0.25);
            --aurora-blue: rgba(52, 152, 219, 0.2);
            --aurora-purple: rgba(155, 89, 182, 0.22);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: var(--bg-main);
            color: var(--text-secondary);
            margin: 0;
            padding: 20px;
            position: relative; /* Required for pseudo-element positioning */
            overflow-x: hidden; /* Prevents scrollbar from aurora effect */
        }
        
        /* --- TOP-ALIGNED AURORA BACKGROUND EFFECT --- */
        body::before,
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 200%;
            height: 40vh; /* MODIFIED: Restrict height to top 40% of the viewport */
            z-index: 0; /* Position behind content */
            opacity: 0.9;
            will-change: transform;
            /* ADDED: Creates a soft fade-out at the bottom of the effect */
            mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 40%, transparent 100%);
        }

        body::before {
            background: 
                /* MODIFIED: Adjusted vertical positions for the new shorter container */
                radial-gradient(circle at 25% 80%, var(--aurora-green) 0%, transparent 50%),
                radial-gradient(circle at 75% 70%, var(--aurora-blue) 0%, transparent 60%);
            animation: moveAurora 30s linear infinite;
        }

        body::after {
            background: 
                /* MODIFIED: Adjusted vertical positions for the new shorter container */
                radial-gradient(circle at 20% 100%, var(--aurora-purple) 0%, transparent 50%),
                radial-gradient(circle at 80% 90%, var(--aurora-green) 0%, transparent 60%);
            animation: moveAurora 45s linear infinite reverse; /* Different duration/direction */
        }

        @keyframes moveAurora {
            from { transform: translateX(-50%); }
            to { transform: translateX(0%); }
        }

        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            position: relative; /* Ensures content stays above the aurora effect */
            z-index: 1;
        }

        /* --- NAVIGATION --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px; }
        .header-nav { display: flex; gap: 10px; align-items: center; }
        h1 { font-size: 2.25rem; color: var(--text-primary); margin: 0; text-align: left; }
        .nav-button { display: inline-flex; align-items: center; gap: 8px; background-color: var(--bg-gauge-track); color: var(--text-primary); padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; border: 1px solid var(--border-color); transition: background-color 0.2s ease, transform 0.2s ease; cursor: pointer; }
        .nav-button:hover { background-color: var(--border-color); transform: translateY(-2px); }
        .nav-button svg { width: 22px; height: 22px; }

        /* --- DASHBOARD GRID LAYOUT --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; }
        
        /* --- CARD STYLING --- */
        .card { 
            background-color: rgba(23, 23, 23, 0.85); /* Slightly transparent to hint at background */
            backdrop-filter: blur(5px); /* Frosted glass effect */
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--border-color); 
            border-radius: 16px; 
            padding: 25px; 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); 
            text-align: center; 
            display: flex; 
            flex-direction: column;
        }
        .card-title { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0 0 20px 0; text-align: left; }

        /* --- NZ FORECAST STYLING --- */
        #nz-spotlight { grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: center; text-align: left; }
        #aurora-score-display { padding-right: 30px; border-right: 1px solid var(--border-color); }
        #aurora-score-label { font-size: 1.1rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; }
        #aurora-score { font-size: 4rem; font-weight: 800; color: var(--text-primary); line-height: 1; }
        .emoji { font-size: 3rem; vertical-align: middle; margin-left: 10px; }
        #last-updated { font-size: 0.9rem; color: var(--text-muted); margin-top: 15px; }
        #thermometer-container { height: 12px; width: 100%; background-color: var(--bg-gauge-track); border-radius: 6px; margin-top: 20px; overflow: hidden; }
        #thermometer-line { height: 100%; border-radius: 6px; width: 0%; transition: width 1.5s ease, background-color 1s ease; }
        #aurora-blurbs { font-size: 1rem; color: var(--text-secondary); }
        .aurora-blurb { display: none; }

        /* --- GAUGE STYLING --- */
        .gauge-grid { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .gauge .card-title { font-size: 1.1rem; text-align: center; }
        .gauge-value { font-size: 2.25rem; font-weight: 700; color: var(--text-primary); margin: 10px 0; }
        .gauge-emoji { font-size: 2rem; margin: 5px 0 15px 0; min-height: 1.2em; }
        .gauge-bar-track { height: 8px; width: 100%; background-color: var(--bg-gauge-track); border-radius: 4px; overflow: hidden; }
        .gauge-bar { height: 100%; width: 0%; border-radius: 4px; transition: width 1.5s ease, background-color 1s ease; }
        .gauge-last-updated { font-size: 0.8rem; color: var(--text-muted); margin-top: auto; padding-top: 15px; }

        /* --- CHART STYLING --- */
        .chart-card { grid-column: span 6; height: 450px; }
        .chart-card canvas { width: 100% !important; height: 100% !important; }

        /* --- MODAL (TUTORIAL) STYLES --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex; /* Changed from 'none' for easier JS toggle */
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px 40px;
            position: relative;
            max-width: 800px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-close-btn {
            position: absolute;
            top: 15px; right: 20px;
            background: none; border: none;
            font-size: 2.5rem;
            font-weight: 300;
            color: var(--text-muted);
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s ease;
        }
        .modal-close-btn:hover { color: var(--text-primary); }
        .modal-content h2 { color: var(--text-primary); margin-top: 0; margin-bottom: 30px; font-size: 1.8rem; }
        .metric-explanation { margin-bottom: 25px; border-left: 3px solid var(--border-color); padding-left: 20px; }
        .metric-explanation h3 { color: var(--text-primary); margin-top: 0; margin-bottom: 8px; }
        .metric-explanation p { margin: 0; line-height: 1.6; }
        .metric-explanation strong { color: var(--text-primary); font-weight: 600; }
        .metric-explanation .key-good { color: #4ade80; /* Green */ }
        .metric-explanation .key-bad { color: #f87171; /* Red */ }
        .metric-explanation .key-important { color: #60a5fa; /* Blue */ }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 1200px) { .chart-card { grid-column: 1 / -1; } }
        @media (max-width: 900px) { h1 { font-size: 1.75rem; } #nz-spotlight { grid-template-columns: 1fr; } #aurora-score-display { border-right: none; border-bottom: 1px solid var(--border-color); padding-right: 0; padding-bottom: 20px; margin-bottom: 20px; } }
        @media (max-width: 600px) { body { padding: 10px; } .header { flex-direction: column; align-items: flex-start; gap: 20px; } .card { padding: 20px; } .modal-content { padding: 25px; } }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <h1>Spot The Aurora - West Coast Aurora Forecast by TNR Protography</h1>
        <div class="header-nav">
            <button id="helpButton" class="nav-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                   <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                   <circle cx="12" cy="12" r="9" />
                   <line x1="12" y1="17" x2="12" y2="17.01" />
                   <path d="M12 13.5a1.5 1.5 0 0 1 1 -1.5a2.6 2.6 0 1 0 -3 -4" />
                </svg>
                <span>Metric Guide</span>
            </button>
            <a href="index.html" class="nav-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="4" /><path d="M12 3v-2" /><path d="M12 21v2" /><path d="M3 12h-2" /><path d="M21 12h2" /><path d="M5.6 5.6l-1.4 -1.4" /><path d="M18.4 5.6l1.4 -1.4" /><path d="M5.6 18.4l-1.4 1.4" /><path d="M18.4 18.4l1.4 1.4" /></svg>
                <span>CME Modeler</span>
            </a>
        </div>
    </header>

    <main class="dashboard-grid">
        <div id="nz-spotlight" class="card">
            <div id="aurora-score-display"><h2 class="card-title">NZ West Coast Aurora Chance</h2><div id="aurora-score">Loading...</div><div id="thermometer-container"><div id="thermometer-line"></div></div><div id="last-updated">Last Updated: Loading...</div></div>
            <div id="aurora-blurbs"><div class="aurora-blurb" id="blurb-10">Little to no auroral activity.</div><div class="aurora-blurb" id="blurb-25">Minimal auroral activity likely.</div><div class="aurora-blurb" id="blurb-40">Clear auroral activity visible in cameras.</div><div class="aurora-blurb" id="blurb-50">Faint auroral glow potentially visible to the naked eye.</div><div class="aurora-blurb" id="blurb-80">Good chance of seeing naked-eye auroral color.</div><div class="aurora-blurb" id="blurb-80plus">High probability of significant auroral substorms.</div></div>
        </div>
        <div class="gauge-grid">
            <div class="card gauge"><h3 class="card-title">Hemispheric Power</h3><div class="gauge-value" id="power-value">...</div><div class="gauge-emoji" id="power-emoji">...</div><div class="gauge-bar-track"><div class="gauge-bar" id="power-gauge-bar"></div></div><div class="gauge-last-updated" id="power-last-updated">...</div></div>
            <div class="card gauge"><h3 class="card-title">Solar Wind Speed</h3><div class="gauge-value" id="speed-value">...</div><div class="gauge-emoji" id="speed-emoji">...</div><div class="gauge-bar-track"><div class="gauge-bar" id="speed-gauge-bar"></div></div><div class="gauge-last-updated" id="speed-last-updated">...</div></div>
            <div class="card gauge"><h3 class="card-title">Solar Wind Density</h3><div class="gauge-value" id="density-value">...</div><div class="gauge-emoji" id="density-emoji">...</div><div class="gauge-bar-track"><div class="gauge-bar" id="density-gauge-bar"></div></div><div class="gauge-last-updated" id="density-last-updated">...</div></div>
            <div class="card gauge"><h3 class="card-title">IMF Bt (Total)</h3><div class="gauge-value" id="bt-value">...</div><div class="gauge-emoji" id="bt-emoji">...</div><div class="gauge-bar-track"><div class="gauge-bar" id="bt-gauge-bar"></div></div><div class="gauge-last-updated" id="bt-last-updated">...</div></div>
            <div class="card gauge"><h3 class="card-title">IMF Bz (N/S)</h3><div class="gauge-value" id="bz-value">...</div><div class="gauge-emoji" id="bz-emoji">...</div><div class="gauge-bar-track"><div class="gauge-bar" id="bz-gauge-bar"></div></div><div class="gauge-last-updated" id="bz-last-updated">...</div></div>
        </div>
        <div class="card chart-card"><h2 class="card-title">Aurora Visibility (Past 3 Hours)</h2><canvas id="auroraChart"></canvas></div>
        <div class="card chart-card"><h2 class="card-title">Magnetic Field Components (Past 24 Hours)</h2><canvas id="magneticFieldChart"></canvas></div>
    </main>
</div>

<!-- Help Modal Structure -->
<div id="helpModal" class="modal-overlay">
    <div class="modal-content">
        <button id="closeModalBtn" class="modal-close-btn">×</button>
        <h2>Understanding the Metrics</h2>

        <div class="metric-explanation">
            <h3>NZ West Coast Aurora Chance (%)</h3>
            <p>This is your main "at-a-glance" forecast. It combines all the other metrics into a single percentage representing the likelihood of seeing an aurora on the West Coast of New Zealand. A higher percentage means a better chance!</p>
        </div>
        
        <div class="metric-explanation">
            <h3>Hemispheric Power (GW)</h3>
            <p>Measures the total energy being deposited into Earth's upper atmosphere. Think of it as the 'fuel' for the aurora. A <span class="key-good">higher value is better</span>. Activity is notable above <strong>30 GW</strong>.</p>
        </div>
        
        <div class="metric-explanation">
            <h3>Solar Wind Speed (km/s)</h3>
            <p>How fast the particles from the sun are traveling. Faster wind hits Earth's magnetic field with more force, creating brighter auroras. A <span class="key-good">higher speed is better</span>. Look for speeds above <strong>500 km/s</strong>.</p>
        </div>
        
        <div class="metric-explanation">
            <h3>Solar Wind Density (p/cm³)</h3>
            <p>The number of particles in a cubic centimeter of the solar wind. Higher density means more particles are available to create light. A <span class="key-good">higher density is better</span>. Values above <strong>10 p/cm³</strong> are good.</p>
        </div>

        <div class="metric-explanation">
            <h3>IMF Bt (Total)</h3>
            <p>Measures the total strength of the Interplanetary Magnetic Field (IMF). A stronger field can transfer more energy into our magnetosphere. A <span class="key-good">higher Bt is better</span>. Values over <strong>10 nT</strong> are good.</p>
        </div>

        <div class="metric-explanation">
            <h3>IMF Bz (N/S)</h3>
            <p>
                <span class="key-important">This is the most critical component.</span> It measures the North/South direction of the IMF. For an aurora to happen, the Bz must be <strong class="key-bad">negative (southward)</strong>.
                A negative Bz 'opens the gate', allowing solar wind energy to pour in. The more negative, the better. <strong class="key-bad">Bz < -5 nT</strong> is needed for good auroras.
            </p>
        </div>
    </div>
</div>

<script>
    // --- Global Variables & Constants ---
    let auroraChartInstance = null;
    let magneticChart = null;
    let apiDataCache = {}; 
    const NOAA_PLASMA_ENDPOINT = 'https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json';
    const NOAA_MAG_ENDPOINT = 'https://services.swpc.noaa.gov/products/solar-wind/mag-1-day.json';
    const GAUGE_API_ENDPOINTS = {
        power: 'https://hemispheric-power.thenamesrock.workers.dev/',
        speed: NOAA_PLASMA_ENDPOINT,
        density: NOAA_PLASMA_ENDPOINT,
        bt: NOAA_MAG_ENDPOINT,
        bz: NOAA_MAG_ENDPOINT
    };
    const GAUGE_THRESHOLDS = { speed: { gray: 250, yellow: 350, orange: 500, red: 650, purple: 800, pink: Infinity, maxExpected: 1000 }, density: { gray: 5, yellow: 10, orange: 15, red: 20, purple: 50, pink: Infinity, maxExpected: 70 }, power: { gray: 20, yellow: 40, orange: 70, red: 150, purple: 200, pink: Infinity, maxExpected: 250 }, bt: { gray: 5, yellow: 10, orange: 15, red: 20, purple: 50, pink: Infinity, maxExpected: 60 }, bz: { gray: -5, yellow: -10, orange: -15, red: -20, purple: -50, pink: -50, maxNegativeExpected: -60 }};
    const GAUGE_COLORS = { gray: '#808080', yellow: '#FFD700', orange: '#FFA500', red: '#FF4500', purple: '#800080', pink: '#FF1493' };
    const GAUGE_EMOJIS = { gray: '\u{1F610}', yellow: '\u{1F642}', orange: '\u{1F642}', red: '\u{1F604}', purple: '\u{1F60D}', pink: '\u{1F60D}', error: '\u{2753}' };
    const UPDATE_INTERVAL_MS = 120000; // 2 minutes in milliseconds
    const CHART_HOURS = 24;
    
    // --- Helper Functions ---
    function formatTimestamp(isoString) { try { const d = new Date(isoString); return isNaN(d.getTime()) ? "Invalid Date" : `${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`; } catch { return "Invalid Date"; } }
    function getGaugeStyle(v, t) { if (v == null || isNaN(v)) return { color: GAUGE_COLORS.gray, emoji: GAUGE_EMOJIS.error, percentage: 0 }; let k='pink', p=0; if (t==='bz') { k=v<=-50?'pink':v<=-20?'purple':v<=-15?'red':v<=-10?'orange':v<=-5?'yellow':'gray'; p=v<0?Math.min(100,Math.max(0,(v/GAUGE_THRESHOLDS.bz.maxNegativeExpected)*100)):0; } else { const th=GAUGE_THRESHOLDS[t]; k=v<=th.gray?'gray':v<=th.yellow?'yellow':v<=th.orange?'orange':v<=th.red?'red':v<=th.purple?'purple':'pink'; p=Math.min(100,Math.max(0,(v/th.maxExpected)*100)); } return { color: GAUGE_COLORS[k], emoji: GAUGE_EMOJIS[k], percentage: p }; }

    // --- Main Update Logic ---
    async function updateGauge(type) {
        const endpoint = GAUGE_API_ENDPOINTS[type];
        const { value: valEl, emoji: emEl, lastUpdated: luEl, bar: barEl } = { value: document.getElementById(`${type}-value`), emoji: document.getElementById(`${type}-emoji`), lastUpdated: document.getElementById(`${type}-last-updated`), bar: document.getElementById(`${type}-gauge-bar`) };
        try {
            if (type === 'power') {
                const response = await fetch(endpoint); if (!response.ok) throw new Error(`Fetch failed for power`);
                const data = await response.json(); const latestData = data.values[data.values.length - 1]; const value = parseFloat(latestData.value); const style = getGaugeStyle(value, type); valEl.innerText = `${value.toFixed(1)} GW`; emEl.innerHTML = style.emoji; luEl.innerText = `Last Updated: ${formatTimestamp(latestData.lastUpdated)}`; barEl.style.width = `${style.percentage}%`; barEl.style.backgroundColor = style.color; return;
            }
            let data = apiDataCache[endpoint];
            if (!data) { const response = await fetch(endpoint); if (!response.ok) throw new Error(`Network error: ${response.status}`); data = await response.json(); apiDataCache[endpoint] = data; }
            if (!Array.isArray(data) || data.length < 2) throw new Error("Invalid NOAA data format");
            const headers = data[0]; const columnName = type === 'bz' ? 'bz_gsm' : type; const valueIndex = headers.indexOf(columnName); const timeIndex = headers.indexOf('time_tag');
            if (valueIndex === -1 || timeIndex === -1) throw new Error(`Column not found: ${columnName}`);
            let latestRow = null;
            for (let i = data.length - 1; i > 0; i--) { const row = data[i]; const val = parseFloat(row[valueIndex]); if (!isNaN(val) && val > -9999) { latestRow = row; break; } }
            if (!latestRow) throw new Error("No valid recent data found");
            const value = parseFloat(latestRow[valueIndex]); const lastUpdated = latestRow[timeIndex];
            const unit = type==='speed'?' km/s':type==='density'?' p/cm³': ' nT'; const style = getGaugeStyle(value, type); valEl.innerText = `${value.toFixed(1)}${unit}`; emEl.innerHTML = style.emoji; luEl.innerText = `Last Updated: ${formatTimestamp(lastUpdated)}`; barEl.style.width = `${style.percentage}%`; barEl.style.backgroundColor = style.color;
        } catch (error) { console.error(`[${type}] Error updating gauge:`, error); valEl.innerText = "Error"; emEl.innerHTML = GAUGE_EMOJIS.error; luEl.innerText = `Update Failed: ${error.message.substring(0,30)}`; barEl.style.width='0%'; }
    }
    
    async function renderMagneticChart() {
        const ctx = document.getElementById('magneticFieldChart').getContext('2d');
        const chartTimeLimit = new Date(Date.now() - CHART_HOURS * 3600 * 1000);
        try {
            let data = apiDataCache[NOAA_MAG_ENDPOINT]; if (!data) { const response = await fetch(NOAA_MAG_ENDPOINT); if (!response.ok) throw new Error(`Fetch failed`); data = await response.json(); apiDataCache[NOAA_MAG_ENDPOINT] = data; }
            if (!Array.isArray(data) || data.length < 2) throw new Error("Invalid NOAA data format");
            const headers = data[0]; const timeIndex = headers.indexOf('time_tag'); const btIndex = headers.indexOf('bt'); const bzIndex = headers.indexOf('bz_gsm');
            const filteredData = data.slice(1).map(row => ({ time: new Date(row[timeIndex]), bt: parseFloat(row[btIndex]) > -9999 ? parseFloat(row[btIndex]) : null, bz: parseFloat(row[bzIndex]) > -9999 ? parseFloat(row[bzIndex]) : null, })).filter(p => p.time >= chartTimeLimit);
            if (filteredData.length === 0) return;
            const labels = filteredData.map(p => p.time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            const btValues = filteredData.map(p => p.bt); const bzValues = filteredData.map(p => p.bz);
            const allValues = [...btValues, ...bzValues].filter(v => v !== null); const dataMin = Math.min(...allValues); const dataMax = Math.max(...allValues);
            const padding = Math.max((dataMax - dataMin) * 0.1, 1); const yMin = Math.floor(dataMin - padding); const yMax = Math.ceil(dataMax + padding);
            const chartData = { labels, datasets: [ { label: 'Bt (Total)', data: btValues, borderColor: '#A9A9A9', backgroundColor: 'rgba(169, 169, 169, 0.2)', borderWidth: 1.5, tension: 0.3, pointRadius: 0, spanGaps: true }, { label: 'Bz (N/S)', data: bzValues, borderColor: '#FF6347', backgroundColor: 'rgba(255, 99, 71, 0.3)', borderWidth: 1.5, tension: 0.3, pointRadius: 0, spanGaps: true } ] };
            if (magneticChart) { magneticChart.data = chartData; magneticChart.options.scales.y.min = yMin; magneticChart.options.scales.y.max = yMax; magneticChart.update(); } 
            else { magneticChart = new Chart(ctx, { type: 'line', data: chartData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#a1a1aa' } }, title: { display: false } }, scales: { x: { ticks: { color: '#71717a', maxRotation: 0, autoSkip: true, maxTicksLimit: 24 }, grid: { color: '#3f3f46' } }, y: { min: yMin, max: yMax, ticks: { color: '#71717a' }, grid: { color: c=>c.tick.value===0?'#fafafa':'#3f3f46', lineWidth:c=>c.tick.value===0?1.5:1 } } }, interaction: { mode: 'index', intersect: false } } }); }
        } catch (e) { console.error("Error rendering magnetic chart:", e); }
    }
    
    // --- NZ Aurora Forecast Functions ---
    async function fetchSensor() {
        try {
            const [tnrResponse, basicResponse] = await Promise.all([fetch('https://tnr-aurora-forecast.thenamesrock.workers.dev/'), fetch('https://basic-aurora-forecast.thenamesrock.workers.dev/')]);
            if (!tnrResponse.ok || !basicResponse.ok) throw new Error(`Fetch failed`);
            const tnrData = await tnrResponse.json(); const basicData = await basicResponse.json(); const scoreValue = parseFloat(tnrData.values.pop().value); document.getElementById('aurora-score').innerHTML = `${scoreValue.toFixed(1)}% <span class="emoji">${getAuroraEmoji(scoreValue)}</span>`;
            const lastUpdated = new Date(basicData.values.pop().lastUpdated); document.getElementById('last-updated').innerText = `Last Updated: ${lastUpdated.toLocaleDateString()} ${lastUpdated.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            updateThermometer(scoreValue); updateAuroraBlurb(scoreValue);
        } catch (error) { console.error("Error fetching NZ sensor data:", error); document.getElementById('aurora-score').innerHTML = `Error <span class="emoji">❓</span>`; document.getElementById('last-updated').innerText = `Update Failed: ${error.message}`; updateThermometer(0); updateAuroraBlurb(-1); }
    }
    function getAuroraEmoji(s){return s<10?'\u{1F61F}':s<25?'\u{1F610}':s<50?'\u{1F642}':s<80?'\u{1F600}':'\u{1F929}'}
    function updateThermometer(s){const t=document.getElementById('thermometer-line');t.style.width=Math.min(s,100)+'%';t.style.backgroundColor=s<10?'#808080':s<25?'#FFD700':s<40?'#FFA500':s<50?'#FF4500':s<80?'#800080':'#FF1493'}
    function updateAuroraBlurb(s){document.querySelectorAll('#aurora-blurbs .aurora-blurb').forEach(e=>e.style.display='none');document.getElementById(s<10?'blurb-10':s<25?'blurb-25':s<40?'blurb-40':s<50?'blurb-50':s<80?'blurb-80':'blurb-80plus').style.display='block'}
    
    async function renderAuroraChart() {
        const ctx = document.getElementById('auroraChart').getContext('2d');
        try {
            const [response1, response2] = await Promise.all([
                fetch('https://basic-aurora-forecast.thenamesrock.workers.dev/'),
                fetch('https://tnr-aurora-forecast.thenamesrock.workers.dev/')
            ]);
            if (!response1.ok || !response2.ok) {
                throw new Error(`Failed to fetch aurora data: ${response1.status}, ${response2.status}`);
            }
            const json1 = await response1.json();
            const json2 = await response2.json();
            const processApiData = (dataArray) => {
                if (!Array.isArray(dataArray)) return [];
                const uniqueMap = new Map(dataArray.map(item => [item.lastUpdated, item]));
                return Array.from(uniqueMap.values())
                    .map(item => ({
                        time: new Date(item.lastUpdated),
                        value: parseFloat(item.value)
                    }))
                    .sort((a, b) => a.time - b.time);
            };
            const data1 = processApiData(json1.values);
            const data2 = processApiData(json2.values);
            const labels = [], points1 = [], points2 = [];
            const now = new Date();
            const threeHoursAgo = now.getTime() - (3 * 60 * 60 * 1000);
            const tenMinutes = 10 * 60 * 1000;
            const startTime = new Date(Math.floor(threeHoursAgo / tenMinutes) * tenMinutes);
            let dataIndex1 = 0, dataIndex2 = 0;
            let lastKnownValue1 = null, lastKnownValue2 = null;
            for (let t = new Date(startTime); t <= now; t.setTime(t.getTime() + tenMinutes)) {
                labels.push(t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                while (dataIndex1 < data1.length && data1[dataIndex1].time <= t) {
                    lastKnownValue1 = data1[dataIndex1].value;
                    dataIndex1++;
                }
                points1.push(lastKnownValue1);
                while (dataIndex2 < data2.length && data2[dataIndex2].time <= t) {
                    lastKnownValue2 = data2[dataIndex2].value;
                    dataIndex2++;
                }
                points2.push(lastKnownValue2);
            }
            const chartData = {
                labels: labels,
                datasets: [
                    { label: 'Base Score', data: points1, borderColor: '#A9A9A9', backgroundColor: 'rgba(169, 169, 169, 0.2)', tension: 0.4, borderWidth: 1.5, pointRadius: 0, spanGaps: true },
                    { label: 'Real Score', data: points2, borderColor: '#FF6347', backgroundColor: 'rgba(255, 99, 71, 0.3)', tension: 0.4, borderWidth: 1.5, pointRadius: 0, spanGaps: true }
                ]
            };
            if (auroraChartInstance) {
                auroraChartInstance.data = chartData;
                auroraChartInstance.update();
            } else {
                auroraChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#a1a1aa' } }, title: { display: false } },
                        scales: {
                            x: { ticks: { color: '#71717a' }, grid: { color: '#3f3f46' } },
                            y: { min: 0, max: 100, ticks: { color: '#71717a' }, grid: { color: '#3f3f46' } }
                        },
                        interaction: { mode: 'index', intersect: false }
                    }
                });
            }
        } catch (e) {
            console.error("Error rendering aurora chart:", e);
        }
    }
    
    // --- Initialization ---
    function runAllUpdates() {
        console.log(`Updating all data at ${new Date().toLocaleTimeString()}...`);
        apiDataCache = {}; // Clear cache to fetch fresh data
        fetchSensor();
        renderAuroraChart();
        Object.keys(GAUGE_API_ENDPOINTS).forEach(type => updateGauge(type));
        renderMagneticChart();
    }
    document.addEventListener('DOMContentLoaded', () => {
        runAllUpdates();
        setInterval(runAllUpdates, UPDATE_INTERVAL_MS);

        // --- NEW: MODAL FUNCTIONALITY ---
        const helpModal = document.getElementById('helpModal');
        const openHelpButton = document.getElementById('helpButton');
        const closeHelpButton = document.getElementById('closeModalBtn');

        function openModal() {
            helpModal.classList.add('visible');
        }
        function closeModal() {
            helpModal.classList.remove('visible');
        }
        openHelpButton.addEventListener('click', openModal);
        closeHelpButton.addEventListener('click', closeModal);
        // Close modal when clicking the overlay
        helpModal.addEventListener('click', (event) => {
            if (event.target === helpModal) {
                closeModal();
            }
        });
        // Close modal with the Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && helpModal.classList.contains('visible')) {
                closeModal();
            }
        });
    });

</script>
</body>
</html>